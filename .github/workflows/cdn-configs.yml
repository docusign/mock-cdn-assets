name: Upload Config Files and Purge Akamai Cache

on:
  push:
    branches:
      - main  # Trigger on push to the main branch
    #paths:
    #  - common-configs/**

jobs:
  upload-and-purge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CDN_1FE_AKAMAI_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.CDN_1FE_AKAMAI_HOST }} >> ~/.ssh/known_hosts

      - name: Upload files to respective destinations
        run: |
          # Define the mapping of files to destinations
          declare -A FILE_DESTINATIONS=(
            ["common-configs/integration.json"]="integration/configs/live.json"
            ["common-configs/stage.json"]="stage/configs/live.json"
            ["common-configs/demo.json"]="demo/configs/live.json"
            ["common-configs/production.json"]="production/configs/live.json"
          )

          # Upload each file to its respective destination
          for FILE in "${!FILE_DESTINATIONS[@]}"; do
            DESTINATION=${FILE_DESTINATIONS[$FILE]}
            echo "Uploading $FILE to $DESTINATION"
            # Stage files
            # Create folders and delete the file locally
            mkdir -p $DESTINATION
            rm -rf $DESTINATION
            # Rename file to live.json
            mv $FILE $DESTINATION
            scp "$DESTINATION" "${{ secrets.CDN_1FE_AKAMAI_USERNAME }}@${{ secrets.CDN_1FE_AKAMAI_HOST }}:/$DESTINATION"
          done

      
            

